<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <link rel="stylesheet" href="https://ssl.gstatic.com/docs/script/css/add-ons1.css">
    <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/smoothness/jquery-ui.css">
    <style>
        input[type=button] {
            cursor: pointer;
        }

        body {
            height: 100%;
        }

        #highlighter-library {
            overflow-y: scroll;
            overflow-x: hidden;
            max-height: 80%;
            height: 80%;
        }

        #bottom {
            position: absolute;
            bottom: 0;
        }

        #highlighter-sets {
            list-style-type: none;
            margin: 0;
            padding: 0;
        }
        
        .highlighter-sets-item {
            margin: 3px;
            padding: 0.4em;
            padding-left: 1.5em;
            font-size: 1.4em;
            background-color: #f9f9f9;
        }
        
        .draggable-set-handle {
            margin-left: -1.3em;
        }

        .highlighters {
            list-style-type: none;
            margin: 0;
            padding: 0;
        }

        .highlighters-item {
            margin: 3px;
            width: fit-content;
            padding: 0.4em;
            padding-left: 1.5em;
            font-size: 1.4em;
            background-color: #f6f6f6;
        }

        .draggable-highlighter-handle {
            margin-left: -1.3em;
        }
    </style>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>

    <script>
        function createDraggable() {
            $("#highlighter-sets").sortable({
                axis: "y",
                handle: ".draggable-set-handle",
                opacity: 0.5,
                tolerance: "pointer"
            });

            $(".highlighters").sortable({
                axis: "y",
                handle: ".draggable-highlighter-handle",
                opacity: 0.5,
                tolerance: "pointer",
                containment: "parent"
            });
        }

        createDraggable();
    </script>
</head>

<body>

    <div id="highlighter-library">
        <? var hSets = hLibrary.highlighterSets; ?>
        <? var currentSetIndex = hLibrary.currentSetIndex; ?>
        <ul id="highlighter-sets">
        <? for (var i = 0; i < hSets.length; i++) { ?>
            <li class="highlighter-sets-item">
                <span class="ui-icon ui-icon-arrowthick-2-n-s draggable-set-handle"></span>
                
                <input type="text" class="set-name" value="<?= hSets[i].setName ?>" placeholder="Set name" />

                <input type="button" class="set-remove" value="-" />

                <? var highlighters = hSets[i].highlighters; ?>
                <ul class="highlighters">
                <? for (var j = 0; j < highlighters.length; j++) { ?>
                    <li class="highlighters-item">
                        <span class="ui-icon ui-icon-arrowthick-2-n-s draggable-highlighter-handle"></span>
                        <input class="highlighter-color" type="color" value="<?= highlighters[j].color ?>" />
                        <input class="highlighter-label" type="text" value="<?= highlighters[j].label ?>" placeholder="Label" />
                        <input class="highlighter-remove" type="button" value="-" />
                    </li>
                <? } ?>
                </ul>

                <input class="highlighter-add" type="button" value="+" />
            </li>
        <? } ?>
        </ul>

        <input type="button" value="New Set" id="set-add" class="share" />
    </div>

    <div id="bottom">
        <input type="button" value="Save" id="save-library-button" class="action" />
        <input type="button" value="Close" id="close-library-button" />
    </div>

</body>

<script>
    var LABEL_KEY = 'label';
    var COLOR_KEY = 'color';
    var SET_NAME_KEY = 'setName';
    var HIGHLIGHTERS_KEY = 'highlighters';
    var CURRENT_SET_INDEX_KEY = 'currentSetIndex';
    var HIGHLIGHTER_SETS_KEY = 'highlighterSets';

    function saveLibrary() {
        const libraryJSON = serializeLibrary();
        console.log(libraryJSON);
        google.script.run
            .withSuccessHandler(function () {
                setTimeout(function () {
                    google.script.host.close();                    
                }, 1000);
            })
            .withFailureHandler(function () {
                alert('Was not able to save the library. Please try again.');
            })
            .saveHighlighterLibraryFromDialog(libraryJSON);
    }

    function serializeLibrary() {
        const highlighterSets = [];
        const currentSetIndex = 0;

        $('#highlighter-sets').children('.highlighter-sets-item').each(
            function () {
                const highlighters = [];
                const setName = $.trim($(this).children('.set-name').val());

                const highlightersContainer = $(this).children('.highlighters')[0];
                $(highlightersContainer).children('.highlighters-item').each(
                    function () {
                        const color = $(this).children('.highlighter-color').val();
                        const label = $(this).children('.highlighter-label').val();
                        const highlighterJSON = {}
                        highlighterJSON[COLOR_KEY] = color;
                        highlighterJSON[LABEL_KEY] = label;
                        highlighters.push(highlighterJSON);
                    }
                );

                const highlighterSetJSON = {};
                highlighterSetJSON[HIGHLIGHTERS_KEY] = highlighters;
                highlighterSetJSON[SET_NAME_KEY] = setName;
                
                highlighterSets.push(highlighterSetJSON);
            }
        );

        const libraryJSON = {};
        libraryJSON[HIGHLIGHTER_SETS_KEY] = highlighterSets;
        libraryJSON[CURRENT_SET_INDEX_KEY] = currentSetIndex;

        return libraryJSON;
    }

    /**
     * Bottom buttons
     */
    $('#save-library-button').on('click', saveLibrary);

    $('#close-library-button').on('click', google.script.host.close);

    /**
     * Disable all bottom buttons when one of them is clicked.
     */
    $('#bottom > input[type=button]').on('click', function () {
        $('#bottom > input[type=button]').attr('disabled', 'disabled');
    });

    /**
     * Add a new set.
     */
    $('#set-add').on('click', function () {
        const highlighterSetLi = document.createElement('li');
        highlighterSetLi.className = 'highlighter-sets-item';

        const span = document.createElement('span');
        span.className = 'ui-icon ui-icon-arrowthick-2-n-s draggable-set-handle';

        const setNameInput = document.createElement('input');
        setNameInput.type = 'text';
        setNameInput.className = 'set-name';
        setNameInput.placeholder = 'Set name';

        const setRemoveInput = document.createElement('input');
        setRemoveInput.type = 'button';
        setRemoveInput.className = 'set-remove';
        setRemoveInput.value = '-';

        const highlightersUl = document.createElement('ul');
        highlightersUl.className = 'highlighters';

        const highlighterAddButton = document.createElement('input');
        highlighterAddButton.className = 'highlighter-add';
        highlighterAddButton.type = 'button';
        highlighterAddButton.value = '+';

        highlighterSetLi.appendChild(span);
        highlighterSetLi.appendChild(document.createTextNode('\u00A0'));
        highlighterSetLi.appendChild(setNameInput);
        highlighterSetLi.appendChild(document.createTextNode('\u00A0'));
        highlighterSetLi.appendChild(setRemoveInput);
        highlighterSetLi.appendChild(document.createTextNode('\u00A0'));
        highlighterSetLi.appendChild(highlightersUl);
        highlighterSetLi.appendChild(document.createTextNode('\u00A0'));
        highlighterSetLi.appendChild(highlighterAddButton);

        $('#highlighter-sets').append(highlighterSetLi);

        $(highlighterAddButton).click();
        createDraggable();
    });

    /**
     * Remove a set.
     */
    $(document).on('click', '.set-remove', function () {
        $(this).parent().remove();
    });

    /**
     * Add a new highlighter to a set.
     */
    $(document).on('click', '.highlighter-add', function () {
        const li = document.createElement('li');
        li.className = 'highlighters-item';

        const span = document.createElement('span');
        span.className = 'ui-icon ui-icon-arrowthick-2-n-s draggable-highlighter-handle';

        const inputColor = document.createElement('input');
        inputColor.className = 'highlighter-color';
        inputColor.type = 'color';
        inputColor.value = '#ff0000';

        const inputLabel = document.createElement('input');
        inputLabel.className = 'highlighter-label';
        inputLabel.type = 'text';
        inputLabel.placeholder = 'Label';

        const inputRemove = document.createElement('input');
        inputRemove.className = 'highlighter-remove';
        inputRemove.type = 'button';
        inputRemove.value = '-';

        li.appendChild(span);
        li.appendChild(document.createTextNode('\u00A0'));
        li.appendChild(inputColor);
        li.appendChild(document.createTextNode('\u00A0'));
        li.appendChild(inputLabel);
        li.appendChild(document.createTextNode('\u00A0'));
        li.appendChild(inputRemove);

        $(this).siblings('.highlighters')[0].appendChild(li);
        createDraggable();
    });

    /**
     * Remove a highlighter from a set.
     */
    $(document).on('click', '.highlighter-remove', function () {
        $(this).parent().remove();
    });

</script>

</html>